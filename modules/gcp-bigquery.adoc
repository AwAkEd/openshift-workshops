## Lab: Integrating with Google Compute Service BigQuery

### Background: Integrating with external services

TODO: Write some content here on external services


#### Exercise: Integrating with Google Compute BigQuery

The sample application that we will be deploying as part of this exercise is
called `publicweatherdata`.  This is a Java Spring Boot application that performs
data queries against a Google Compute BigQuery to locate and return map
coordinates of public weather sensors, with average temperature information for a given month.
That was just a fancy way of saying that we are going to deploy, yet again, a webservice that returns a JSON list of places.

#### Create web application credentials

First, you need to allow the server side code to connect to your Google API. For this
you will need a *service account*, which is an account that belongs to your application
instead of to an individual end user. The application calls Google APIs on behalf of the
service account, so users aren't directly involved.

To support server-to-server interactions, first create a service account for your project in the API Console

Then, your application prepares to make authorized API calls by using the service account's credentials to request an access token from the OAuth 2.0 auth server.

Finally, your application can use the access token to call Google APIs.

#### Creating a Google Compute service account

A service account's credentials include a generated email address that is unique and at least one public/private key pair.

If your application doesn't run on Google App Engine or Google Compute Engine, you must obtain these credentials in the Google API Console. To generate service-account credentials, or to view the public credentials that you've already generated, do the following:

* Open the link:https://console.developers.google.com/permissions/serviceaccounts[Service accounts page]. If prompted, select a project.
* Click *Create service account*.
* In the *Create service account* window, type a name for the service account, and select *Furnish a new private key.* Then click *Create*.
+
image:/images/create_gcp_service_account.png[]
+
image:/images/gcp_service_account_created.png[]

Your new public/private key pair is generated and downloaded to your machine; it serves as the only copy of this key. You are responsible for storing it securely.

You can return to the link:https://console.developers.google.com/[API Console] at any time to view the email address, public key fingerprints, and other information, or to generate additional public/private key pairs.
+
image:/images/gcp_service_accounts.png[]

Take note of the service account's email address and store the service account's P12 private key file in a location accessible to your application. Your application needs them to make authorized API calls.

#### Create a secret with the service account information

Once you have your Google credentials created, you need to provide them to the application. For this purpose we will use *link:https://docs.openshift.org/latest/dev_guide/secrets.html[OpenShift's secrets]*.

It is as easy as:

[source,bash]
----
oc create secret generic google-creds --from-file=/tmp/google-creds.json
----

And then you can validate that the secrets have been created:

[source,bash]
----
$oc describe secret/google-creds
Name:      google-creds
Namespace:   roadshow
Labels:      <none>
Annotations:   <none>

Type:   Opaque

Data
====
google-creds.json:   2338 bytes
----

#### Deploy a template to connect to BigTable
Because the `publicweatherdata` application is a back-end to serve data that our
existing front-end will consume, we are going to build it inside the existing
`{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}` project. And, we will do it from the web console.

##### Using application code on embedded GitLab

OpenShift can work with any accessible Git repository. This could be GitHub,
GitLab, or any other server that speaks Git. You can even register webhooks in
your Git server to initiate OpenShift builds triggered by any update to the
application code!

The repository that we are going to use is already cloned in the internal GitLab repository
and located at the following URL:

http://{{GITLAB_URL_PREFIX}}.{{ROUTER_ADDRESS}}/{{GITLAB_USER}}/publicweatherdata.git[http://{{GITLAB_URL_PREFIX}}.{{ROUTER_ADDRESS}}/{{GITLAB_USER}}/publicweatherdata.git]

#### Build and deploy the Application on OpenShift

In the OpenShift web console, find your `{{EXPLORE_PROJECT_NAME}}{{USER_SUFFIX}}` project, and then
click the *"Add to Project"* button. You will see a number of runtimes and templates that you
can choose from, but you will want to select, so let's filter using `gcp`.

image:/images/gcp_template_filter.png[Runtimes]

After you click `publicweatherdata`, on the next screen you will need to enter some configuration for the template. For the Git repository URL, enter:

[source]
----
http://{{GITLAB_URL_PREFIX}}.{{ROUTER_ADDRESS}}/{{GITLAB_USER}}/publicweatherdata.git
----

Also, you will need to provide some configuration for the application to connect to the Google BigQuery service.

The values required are:

* *Month*: Month of the year for which you want to get weather information (with 2 digit format).
* *GCP Project Id*: This is a reference to your Google's project id to use. Find this value in the Google Compute.
+
image:/images/gcp_project_id.png[Google Project Id]
+
* *GCP Credentials dir*: This is where the application will find the google credentials json file that we have mounted as a secret. Use the value provided.
* *GCP Credentials filename*: This is the name of the google's credentials file that has been stored in the secret. Use the default value.

[NOTE]
====
To speed build process, a Sonatype Nexus server is running in the
environment that will cache your dependencies as you pull them down. To use it add an environment variable named *MAVEN_MIRROR_URL* with value `http://nexus.workshop-infra:8081/content/groups/public`
====

image:/images/gcp_template_use.png[]

You can then hit the button labeled *"Create"*. Then click *Continue to
overview*. Once the application has been succesfully built and deployed, you will see this in the web console:

image:/images/gcp_publicweatherdata.png[]

#### Build and deploy the Application on OpenShift

Once the application is deployed, you'll see in the map a new service added. As this service provides too much information, it's only enabled when zoomed in to the map, otherwise you will see a message in the bottom left corner indicating that data retrieval is disabled.

Zoom in, into an area of your choice an you'll see the data displayed. You can click on any dot to get the actual values.

image:/images/gcp_weather_map.png[]

This information is directly coming from querying a Google Compute Big Table.
